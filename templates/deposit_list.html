{% extends "base.html" %}
{% block title %}My Deposits â€“ Crypto-Tracker{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10 col-md-12">
    <div class="card mt-4">
      <div class="card-body">
        <h3 class="card-title mb-4 text-center">My Deposits</h3>
        <div id="alert"></div>

        <!-- Filter Form -->
        <form id="filterForm" class="mb-4">
          <div class="row">
            <div class="col-md-3">
              <select id="currency" name="currency" class="form-select">
                <option value="">All Currencies</option>
                <option value="BTC">BTC</option>
                <option value="ETH">ETH</option>
                <option value="USDT">USDT</option>
              </select>
            </div>
            <div class="col-md-3">
              <input type="text" id="search" placeholder="Search Transaction ID" class="form-control">
            </div>
            <div class="col-md-3">
              <input type="number" step="0.01" id="minAmount" placeholder="Min Amount" class="form-control">
            </div>
            <div class="col-md-3">
              <input type="number" step="0.01" id="maxAmount" placeholder="Max Amount" class="form-control">
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100 mt-3">Apply Filters</button>
        </form>

        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Amount</th>
                <th scope="col">Currency</th>
                <th scope="col">Transaction ID</th>
                <th scope="col">Date</th>
                <th scope="col">Status</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <!-- Pagination controls -->
        <div class="d-flex justify-content-between my-3">
          <button id="prev-btn" class="btn btn-secondary" disabled>Previous</button>
          <button id="next-btn" class="btn btn-secondary" disabled>Next</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  let nextUrl = '/api/deposits/?page=1';
  let prevUrl = null;

  // Load deposits with applied filters
  async function loadDeposits(url) {
    const token = localStorage.getItem('token');
    const res = await fetch(url, {
      headers: { 'Authorization': 'Token ' + token }
    });

    if (!res.ok) {
      document.getElementById('rows').innerHTML =
        `<tr><td colspan="6" class="text-center text-danger">
           Please log in to view deposits.
         </td></tr>`;
      return;
    }

    const data = await res.json();
    console.log('API response:', data);

    // Update paging URLs
    nextUrl = data.next;
    prevUrl = data.previous;
    document.getElementById('next-btn').disabled = !nextUrl;
    document.getElementById('prev-btn').disabled = !prevUrl;

    // Render the current page of deposits
    const list = data.results || [];
    const rowsHtml = list.map(d => {
      const amount = parseFloat(d.amount).toFixed(2);
      let dateDisplay = '-';
      if (d.created) {
        const dt = new Date(d.created.replace('Z',''));
        if (!isNaN(dt)) dateDisplay = dt.toLocaleString();
      }
      const statusDisplay = d.status.charAt(0).toUpperCase() + d.status.slice(1);
      return `
        <tr>
          <th scope="row">${d.id}</th>
          <td>${amount}</td>
          <td>${d.currency}</td>
          <td>${d.trx_id}</td>
          <td>${dateDisplay}</td>
          <td>${statusDisplay}</td>
        </tr>`;
    }).join('');
    document.getElementById('rows').innerHTML = rowsHtml || 
      `<tr><td colspan="6" class="text-center">No deposits found.</td></tr>`;
  }

  // Wire up pagination buttons
  document.getElementById('prev-btn').addEventListener('click', () => {
    if (prevUrl) loadDeposits(prevUrl);
  });
  document.getElementById('next-btn').addEventListener('click', () => {
    if (nextUrl) loadDeposits(nextUrl);
  });

  // Filter form functionality
  document.getElementById('filterForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const params = new URLSearchParams();

    const currency = document.getElementById('currency').value;
    const search = document.getElementById('search').value;
    const minAmount = document.getElementById('minAmount').value;
    const maxAmount = document.getElementById('maxAmount').value;

    if (currency) params.append('currency', currency);
    if (search) params.append('search', search);
    if (minAmount) params.append('min_amount', minAmount);
    if (maxAmount) params.append('max_amount', maxAmount);

    const url = `/api/deposits/?${params.toString()}&page=1`;  // Reset to page 1 on filter change
    loadDeposits(url);
  });

  // Initial load
  window.addEventListener('DOMContentLoaded', () => loadDeposits(nextUrl));
</script>
{% endblock %}
